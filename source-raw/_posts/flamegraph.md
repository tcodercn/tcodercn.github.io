---
title: 性能优化之火焰图
date: 2019-6-29 18:12:30
tags: 
  - 性能
  - 火焰图
  - performance
  - flamegraph

---

## 性能指标
如果我们要做性能优化，首先要明白如何衡量性能。性能主要看三大指标：响应时间、并发数和TPS

### 响应时间
客户端发出请求到接收到响应，两者的时间差即为响应时间。例如12:01:01秒发出请求，12:01:05秒接收到响应，则该笔交易响应时间为4秒。

响应时间按照所处阶段可以划分为三大部分：

1. 通讯链路，包括客户端与业务系统之间请求链路、应答链路的耗时。
2. 业务系统内部，包括队列堆积，计算判断，数据库，文件IO等各种操作导致的耗时。
3. 上游系统，即业务系统依赖的上游系统的处理时间。

![响应时间-1](flamegraph/flamegraph-rt-1.png)

### 并发数
即系统同时并发处理的请求数量。由两个因素决定：

1. 客户端请求数量，对应loadrunner里面的用户数；
2. 系统处理器数量，对应系统线程池数量；

当[1]<[2]，系统处于空闲状态，此时并发数为[1]，差异部分为系统处理器空闲数量
![并发数-1](flamegraph/flamegraph-cc-1.png)

当[1]>[2]，系统处于过载状态，此时并发数为[2]，差异部分为客户端请求排队数量
![并发数-1](flamegraph/flamegraph-cc-2.png)

当[1]=[2]（或稍微大于），系统处理全速状态，此时既不会产生大量的客户端请求排队，也不会出现系统处理空闲的情况，因此吞吐量会达到最优状态。

### TPS - 每秒处理事务数
如果系统平均一秒可以处理100笔交易，则TPS为100。

TPS是衡量系统吞吐量最直观，也是最重要的指标。可以简单分析得出，TPS与并发数成正比，与**平均响应时间**成反比，即TPS=并发数/平均响应时间。例如一个系统并发数为100，平均响应时间0.1秒，则其TPS=(100/0.1)=1000，也就是一秒钟可以处理1000笔交易。

并发数固定，响应时间不同产生的TPS差异对比：

![并发数-1](flamegraph/flamegraph-tps-1.png)


响应时间固定，并发数不同产生的TPS差异对比：

![并发数-1](flamegraph/flamegraph-tps-2.png)

## 分析方法
